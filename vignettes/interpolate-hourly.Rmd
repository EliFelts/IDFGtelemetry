---
title: "Interpolating hourly fish locations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Interpolating hourly fish locations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Overview

The function `interpolate_hourly()` is used to construct best estimates of hourly locations for individual fish based on detection histories. The location for each hour during which an individual fish was actually detected is summarized - if an individual was detected at multiple locations during an hour this will give the first detection in that hour. The next actual detection is also logged, then the data table is expanded to include each hour from the first actual detection to the latest for each individual. If sequential actual detections are at the same location then intervening hours assume that individual remained at that location. If sequential actual detections are at different locations then intervening hours assume that individuals moved at a constant rate between those locations over the span of time between actual detections. These locations are snapped to the nearest 0.1 km points assuming the fish moved in the straightest possible path while remaining in the water.

## Assumptions

The purpose of constructing these estimated paths is to visualize broad movement patterns over relatively long periods of time, not to portray strictly accurate representations of fish location at any given time. Bearing that in mind, it's worth noting key assumptions made in this interpolation process, which include:

-   Fish remain at a fixed location when sequential detections are at the same deployment location

-   Fish moved in the most efficient path possible at a constant rate when moving between deployment locations.

Generally speaking, the longer the interval is between actual detections the more uncertainty there is in these representations.

# Example Code

## Load Packages

The `IDFGtelemetry` package itself isn't on CRAN so it needs to be loaded from the GitHub remote using the following code:

```{r, eval=FALSE}

install.packages("remotes")
remotes::install_github("EliFelts/IDFGtelemetry", force=TRUE)

```

Now load the packages we'll need.

```{r setup, eval=FALSE, message=FALSE}

library(IDFGtelemetry)
library(tidyverse)
library(arrow)

```

## Individual Fish

The `IDFGtelemetry` package includes an example data set, `detections_example` that includes detections of 5 Walleye which moved a substantial amount for the entire calendar year 2024.

First, subset an individual fish and run the function to interpolate locations for that individual. Get id for individuals:

```{r}

unique(detections_example$fish_id)

```

Just grab the first one and subset detections of that indiviual. Note that a data frame of current deployments and the associated network of pairwise connections between those deployments, represented by points at 0.1 km intervals, are loaded with the package as well.

```{r}

ind_example <- interpolate_hourly(detections = detections_example,
                                  fish_id = "1327672_2019-11-06_WAE")

```

## Groups of fish

Often, the goal will be to create this type of data for multiple fish. To do so, iterate through multiple `fish_id` on the `interpolate_hourly()` function. Here, that is carried out on all 5 individuals in the example data set.

```{r}

unique_fish <- unique(detections_example$fish_id)


iterate_example <- map_dfr(
  unique_fish, ~ interpolate_hourly(
    detections = detections_example,
    fish_id = .x
  )
)

```

The majority of the time, iterating over a group will be the best approach unless you know beforehand you want to examine a specific individual. With this hourly data set for each individual in a group, it is straightforward to iterate on the `fish_animations()` function to build animations for each fish in the group.
